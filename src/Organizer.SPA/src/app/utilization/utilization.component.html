<div class="filters-header" role="group" aria-label="Utilization filters">
  <button mat-mini-fab color="primary" 
          (click)="changeYear(selectedYear - 1)"
          aria-label="Previous year">-</button>&nbsp;
  <mat-form-field class="year-box">
    <mat-label>Year</mat-label>
    <input matInput 
           type="number" 
           [ngModel]="selectedYear"
           (keyup.enter)="changeYear($any($event.target).value)"
           aria-label="Select year" />
  </mat-form-field>
  &nbsp;&nbsp;
  <button mat-mini-fab color="primary" 
          (click)="changeYear(selectedYear + 1)"
          aria-label="Next year">+</button>
  <mat-form-field class="filter-box target-box">
    <mat-label>Target %</mat-label>
    <input matInput 
           type="number" 
           min="0" 
           max="100" 
           [ngModel]="target"
           (keyup.enter)="recalculateTargets($any($event.target).value)"
           aria-label="Target percentage" />
  </mat-form-field>
  <mat-checkbox [(ngModel)]="includeNotConfirmed" 
                (change)="changeIncludeNotConfirmed()"
                color="primary">
    Include not confirmed
  </mat-checkbox>
</div>

@if (utilization) {
  <div class="utilization-container" role="region" aria-label="Utilization data">
    <!-- Responsive Table using CSS Grid -->
    <div class="utilization-grid" role="table" aria-label="Monthly utilization">
      <!-- Header Row -->
      <div class="grid-header" role="row">
        <div class="header-cell" role="columnheader">Period</div>
        <div class="header-cell" role="columnheader">Billable</div>
        <div class="header-cell hide-mobile" role="columnheader">To Bill</div>
        <div class="header-cell" role="columnheader">Billed</div>
        <div class="header-cell hide-mobile" role="columnheader">% Billed</div>
        <div class="header-cell" role="columnheader">Target</div>
        <div class="header-cell" role="columnheader">Days Left</div>
      </div>

      <!-- Monthly Data -->
      <div class="section-group months">
        @for (row of utilization.utilizationMonths; track row.monthNumber) {
          <div class="grid-row" role="row">
            <div class="cell period-cell" role="cell">{{ row.description }}</div>
            <div class="cell numeric" role="cell">{{ row.billableHours | number:'1.0-1' }}</div>
            <div class="cell numeric hide-mobile" role="cell">{{ row.toBeBilledHours | number:'1.0-1' }}</div>
            <div class="cell numeric" [class]="getBilledHoursClass(row)" role="cell">
              {{ row.billedHours | number:'1.0-1' }}
            </div>
            <div class="cell numeric hide-mobile" role="cell">{{ row.percentageBilledHours | number:'1.0-1' }}%</div>
            <div class="cell numeric" [class]="getTargetClass(row)" role="cell">
              {{ row.target | number:'1.0-1' }}%
            </div>
            <div class="cell numeric" [class]="getDaysToTargetClass(row)" role="cell">
              {{ row.daysToTarget | number:'1.0-1' }}
            </div>
          </div>
        }
      </div>

      <!-- Quarterly Summary -->
      <div class="section-group quarters">
        @for (row of utilization.utilizationQuarter; track row.description) {
          <div class="grid-row summary-row" role="row">
            <div class="cell period-cell" role="cell">{{ row.description }}</div>
            <div class="cell numeric" role="cell">{{ row.billableHours | number:'1.0-1' }}</div>
            <div class="cell numeric hide-mobile" role="cell">{{ row.toBeBilledHours | number:'1.0-1' }}</div>
            <div class="cell numeric" [class]="getBilledHoursClass(row)" role="cell">
              {{ row.billedHours | number:'1.0-1' }}
            </div>
            <div class="cell numeric hide-mobile" role="cell">{{ row.percentageBilledHours | number:'1.0-1' }}%</div>
            <div class="cell numeric" [class]="getTargetClass(row)" role="cell">
              {{ row.target | number:'1.0-1' }}%
            </div>
            <div class="cell numeric" [class]="getDaysToTargetClass(row)" role="cell">
              {{ row.daysToTarget | number:'1.0-1' }}
            </div>
          </div>
        }
      </div>

      <!-- Half-Year Summary -->
      <div class="section-group halves">
        @for (row of utilization.utilizationHalf; track row.description) {
          <div class="grid-row summary-row" role="row">
            <div class="cell period-cell" role="cell">{{ row.description }}</div>
            <div class="cell numeric" role="cell">{{ row.billableHours | number:'1.0-1' }}</div>
            <div class="cell numeric hide-mobile" role="cell">{{ row.toBeBilledHours | number:'1.0-1' }}</div>
            <div class="cell numeric" [class]="getBilledHoursClass(row)" role="cell">
              {{ row.billedHours | number:'1.0-1' }}
            </div>
            <div class="cell numeric hide-mobile" role="cell">{{ row.percentageBilledHours | number:'1.0-1' }}%</div>
            <div class="cell numeric" [class]="getTargetClass(row)" role="cell">
              {{ row.target | number:'1.0-1' }}%
            </div>
            <div class="cell numeric" [class]="getDaysToTargetClass(row)" role="cell">
              {{ row.daysToTarget | number:'1.0-1' }}
            </div>
          </div>
        }
      </div>

      <!-- Year Summary -->
      @if (utilization.utilizationYear) {
        <div class="section-group year-total">
          <div class="grid-row total-row" role="row">
            <div class="cell period-cell" role="cell">{{ utilization.utilizationYear.description }}</div>
            <div class="cell numeric" role="cell">{{ utilization.utilizationYear.billableHours | number:'1.0-1' }}</div>
            <div class="cell numeric hide-mobile" role="cell">{{ utilization.utilizationYear.toBeBilledHours | number:'1.0-1' }}</div>
            <div class="cell numeric" [class]="getBilledHoursClass(utilization.utilizationYear)" role="cell">
              {{ utilization.utilizationYear.billedHours | number:'1.0-1' }}
            </div>
            <div class="cell numeric hide-mobile" role="cell">{{ utilization.utilizationYear.percentageBilledHours | number:'1.0-1' }}%</div>
            <div class="cell numeric" [class]="getTargetClass(utilization.utilizationYear)" role="cell">
              {{ utilization.utilizationYear.target | number:'1.0-1' }}%
            </div>
            <div class="cell numeric" [class]="getDaysToTargetClass(utilization.utilizationYear)" role="cell">
              {{ utilization.utilizationYear.daysToTarget | number:'1.0-1' }}
            </div>
          </div>
        </div>
      }
    </div>
  </div>
} @else {
  <div class="loading-state">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    <p>Loading utilization data...</p>
  </div>
}