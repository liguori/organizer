<div class="container-box">
  <div class="filters-header">
    <button mat-mini-fab color="primary" (click)="changeCurrentIndex(-1)">-</button>&nbsp;
    @if (selectedView == calendarView.Month) {
    <mat-form-field id="calendar-select-date-filter">
      <input matInput [ngModel]="selectedDate" ng-model-options="{timezone: 'utc'}" [matDatepicker]="dateToPicker"
        placeholder="To" (dateChange)="changeDate($event.value)">
      <mat-datepicker-toggle matSuffix [for]="dateToPicker"></mat-datepicker-toggle>
      <mat-datepicker #dateToPicker></mat-datepicker>
    </mat-form-field>
    }
    @if (selectedView == calendarView.Year) {
    <mat-form-field class="year-box">
      <mat-label>Year</mat-label>
      <input matInput placeholder="Year" maxlength="4" [ngModel]="selectedYear"
        (keyup.enter)="changeCurrentIndex($event.target.value)">
    </mat-form-field>
    }
    &nbsp;&nbsp;
    <button mat-mini-fab color="primary" (click)="changeCurrentIndex(+1)">+</button>
    <mat-form-field class="filter-box" id="calendar-view-filter">
      <mat-label>View</mat-label>
      <mat-select [(ngModel)]="selectedView" (selectionChange)="calendarSelected($event.value)">
        <mat-option [value]="calendarView.Year">Year</mat-option>
        <mat-option [value]="calendarView.Month">Month</mat-option>
      </mat-select>
    </mat-form-field>&nbsp;

    <!-- Reusable Calendar Filter Template -->
    <ng-template #calendarFilterTemplate>
      <mat-form-field id="calendar-project-filter" class="filter-box">
        <mat-label>Project</mat-label>
        <input matInput placeholder="Project" maxlength="10" [ngModel]="filterProject"
          (keyup.enter)="changeFilterProject($event.target.value)">
      </mat-form-field>
      <mat-form-field class="filter-box" id="calendar-view-display">
        <mat-label>Display</mat-label>
        <mat-select [(ngModel)]="selectedDisplay" (selectionChange)="displaySelected($event.value)">
          <mat-option [value]="calendarDisplay.Event">Event</mat-option>
          <mat-option [value]="calendarDisplay.Calendar">Calendar</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field class="filter-box">
        <mat-label>Calendar</mat-label>
        <mat-select #calendarSelection [(ngModel)]="selectedCalendar" placeholder="Calendar"
          (selectionChange)="calendarSelected($event.value)">
          <mat-option value="">Main</mat-option>
          @for (calendar of calendars; track calendar) {
          <mat-option [value]="calendar.calendarName">
            <div>
              <span>{{calendar.description}}</span>
              @if (selectedCalendar!=calendar.calendarName || calendarSelection.panelOpen) {
              <span>
                <span (click)="showCalendarEditorDialog($event,calendar.calendarName)" title="Edit calendar">
                  <mat-icon>edit</mat-icon>
                </span>
                <span (click)="deleteCalendar($event,calendar.calendarName)" title="Delete calendar">
                  <mat-icon>delete_forever</mat-icon>
                </span>
              </span>
              }
            </div>
          </mat-option>
          }
        </mat-select>
      </mat-form-field>
    </ng-template>

    <!-- Reusable Appointment Filter Template -->
    <ng-template #appointmentFilterTemplate let-filterAppointmentRef="filterAppointmentRef">
      <mat-form-field id="calendar-appointment-filter" class="filter-box">
        <mat-label>Appointment</mat-label>
        <mat-select #filterAppointment multiple [(ngModel)]="selectedAppointmentDescriptions"
          (selectionChange)="filterAppointmentDescriptionSelectedValueChange($event)">
          <mat-option>
            <ngx-mat-select-search [(ngModel)]="filterSelectedAppointmentDescription" [placeholderLabel]="'Search...'"
              [noEntriesFoundLabel]="'Not found'" name="search"></ngx-mat-select-search>
          </mat-option>
          @for (desc of getAppointmentDescriptions(); track desc) {
          <mat-option [value]="desc">{{desc}}
          </mat-option>
          }
        </mat-select>
      </mat-form-field>
    </ng-template>

    <!-- Desktop filters: Calendar, Customer, and action buttons (hidden on mobile) -->
    <div class="desktop-only-filters">
      <ng-container *ngTemplateOutlet="calendarFilterTemplate"></ng-container>&nbsp;
      <button mat-mini-fab color="primary" (click)="createCalendar()">
        <mat-icon>create_new_folder</mat-icon>
      </button>
      <ng-container *ngTemplateOutlet="appointmentFilterTemplate"></ng-container>
      <button mat-icon-button color="primary" aria-label="Clear appointment filter" (click)="clearAppointmentDescriptionFilter()">
        <mat-icon>clear</mat-icon>
      </button>
      @if (upstreamEventTokenEnabled) {
      <button mat-mini-fab [color]="upstreamEventToken ? 'accent' : 'primary'" (click)="showUpstreamEventTokenDialog()"
        title="Upstream Event Token">
        <mat-icon>vpn_key</mat-icon>
      </button>
      }
      <div class="calendar-option">
        <span class="appointment-counter" [title]="getFilteredAppointmentsCount() + ' days shown'">
          <mat-icon class="counter-icon">event_note</mat-icon>{{getFilteredAppointmentsCount()}}
        </span>
        @if (this.getWarnings().length>0) {
        <button (click)="showDialogWarning()" mat-mini-fab color="warn" class="warning-button">
          <mat-icon>warning</mat-icon>
        </button>
        }
        <button (click)="availability()" mat-mini-fab color="primary" title="Availability">
          <mat-icon>event_available</mat-icon>
        </button>&nbsp;
        <button (click)="withTravelOrOther()" mat-mini-fab color="primary" title="Travel/Other">
          <mat-icon>flight_takeoff</mat-icon>
        </button>
        @if (selectedDates.size > 0 || selectedAppointments.size > 0) {
        <button (click)="bulkCreateAppointment()" mat-mini-fab color="primary" class="selection-button"
          [disabled]="selectedDates.size === 0" title="Create appointments ({{selectedDates.size}})">
          <mat-icon>add</mat-icon>
          <span class="selection-badge">{{selectedDates.size}}</span>
        </button>
        <button (click)="bulkDeleteAppointments()" mat-mini-fab color="warn" class="selection-button"
          [disabled]="selectedAppointments.size === 0" title="Delete appointments ({{selectedAppointments.size}})">
          <mat-icon>delete</mat-icon>
          <span class="selection-badge">{{selectedAppointments.size}}</span>
        </button>
        <button (click)="clearSelection()" mat-icon-button color="primary" class="selection-button"
          title="Clear selection">
          <mat-icon>clear</mat-icon>
        </button>
        }
      </div>
    </div>

    <!-- Mobile: counter + FAB button to open filters dialog -->
    <span class="appointment-counter mobile-only-counter" [title]="getFilteredAppointmentsCount() + ' days shown'">
      <mat-icon class="counter-icon">event_note</mat-icon>{{getFilteredAppointmentsCount()}}
    </span>
    <button mat-mini-fab color="accent" class="mobile-filters-fab" (click)="openMobileFilters()"
      title="More Filters & Actions">
      <mat-icon>tune</mat-icon>
    </button>
  </div>
  <div class="calendar-container">
    <app-calendar class="calendar-app" [currentYear]="selectedYear" [filterProject]="filterProject"
      [appointments]="appointments" [upstreamEventToken]="upstreamEventToken" [currentView]="selectedView"
      [selectedDisplay]="selectedDisplay" [currentMonthStartDate]="selectedDate" [selectedDates]="selectedDates"
      [selectedAppointments]="selectedAppointments" (daySelected)="calendarDaySelected($event.date, $event.event)"
      (eventSelected)="calendarEventSelected($event.appointment, $event.event)"></app-calendar>
  </div>
</div>